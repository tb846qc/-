<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FHEVM æœºå¯†æ¸¸æˆç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .nav-bar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .nav-links {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .nav-links a:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .wallet-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .card h2 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #718096 0%, #4a5568 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .status.success {
            background: #f0fff4;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .status.error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }

        .status.info {
            background: #ebf8ff;
            color: #2a4365;
            border: 1px solid #90cdf4;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
        }

        .game-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .game-card:hover {
            transform: translateY(-5px);
        }

        .game-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .game-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .game-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .game-status.active {
            background: #c6f6d5;
            color: #22543d;
        }

        .game-status.ended {
            background: #fed7d7;
            color: #742a2a;
        }

        .game-status.waiting {
            background: #fef5e7;
            color: #744210;
        }

        .game-details {
            background: #f7fafc;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .detail-row:last-child {
            margin-bottom: 0;
        }

        .detail-label {
            font-weight: 600;
            color: #4a5568;
        }

        .detail-value {
            color: #2d3748;
            font-weight: 500;
        }

        .score-highlight {
            color: #667eea;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .player-stats {
            background: #f7fafc;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #718096;
        }

        .leaderboard {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            transition: background-color 0.3s ease;
        }

        .leaderboard-item:hover {
            background: #f7fafc;
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .rank {
            font-weight: 700;
            font-size: 1.1rem;
            color: #667eea;
            min-width: 30px;
        }

        .rank.gold {
            color: #ffd700;
        }

        .rank.silver {
            color: #c0c0c0;
        }

        .rank.bronze {
            color: #cd7f32;
        }

        .player-name {
            flex: 1;
            margin-left: 15px;
            font-weight: 600;
        }

        .player-score {
            font-weight: 700;
            color: #2d3748;
        }

        .achievement {
            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin: 5px;
            display: inline-block;
        }

        .tabs {
            display: flex;
            background: #f7fafc;
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .tab.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .game-controls {
            background: #f7fafc;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .score-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .score-input input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .nav-bar {
                flex-direction: column;
                gap: 15px;
            }

            .wallet-section {
                width: 100%;
                justify-content: center;
            }

            .score-input {
                flex-direction: column;
            }

            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ® FHEVM æœºå¯†æ¸¸æˆç³»ç»Ÿ</h1>
            <p>åŸºäºå®Œå…¨åŒæ€åŠ å¯†çš„éšç§ä¿æŠ¤æ¸¸æˆå¹³å°</p>
        </div>

        <div class="nav-bar">
            <div class="nav-links">
                <a href="/">ğŸ  é¦–é¡µ</a>
                <a href="/voting">ğŸ—³ï¸ æŠ•ç¥¨ç³»ç»Ÿ</a>
                <a href="/auction">ğŸ›ï¸ æ‹å–å¹³å°</a>
                <a href="/factory">ğŸ­ åˆçº¦å·¥å‚</a>
            </div>
            <div class="wallet-section">
                <button id="connectWallet" class="btn">è¿æ¥é’±åŒ…</button>
                <span id="walletAddress" class="hidden"></span>
            </div>
        </div>

        <div id="status" class="status hidden"></div>

        <!-- ç©å®¶ä¿¡æ¯ -->
        <div id="playerInfo" class="card hidden">
            <h2>ğŸ‘¤ ç©å®¶ä¿¡æ¯</h2>
            <div class="player-stats">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalGames">0</div>
                        <div class="stat-label">æ€»æ¸¸æˆæ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalScore">0</div>
                        <div class="stat-label">æ€»åˆ†æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="averageScore">0</div>
                        <div class="stat-label">å¹³å‡åˆ†æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="highestScore">0</div>
                        <div class="stat-label">æœ€é«˜åˆ†æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="playerRank">-</div>
                        <div class="stat-label">æ’å</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="achievementCount">0</div>
                        <div class="stat-label">æˆå°±æ•°é‡</div>
                    </div>
                </div>
                <div id="playerAchievements" style="margin-top: 15px;">
                    <!-- æˆå°±å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <div class="card">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('play')">ğŸ® æ¸¸æˆå¤§å…</div>
                <div class="tab" onclick="switchTab('sessions')">ğŸ“Š æ¸¸æˆè®°å½•</div>
                <div class="tab" onclick="switchTab('leaderboard')">ğŸ† æ’è¡Œæ¦œ</div>
                <div class="tab" onclick="switchTab('admin')">âš™ï¸ ç®¡ç†</div>
            </div>

            <!-- æ¸¸æˆå¤§å… -->
            <div id="play" class="tab-content active">
                <h2>æ¸¸æˆå¤§å…</h2>
                
                <div class="game-controls">
                    <h3>å¼€å§‹æ–°æ¸¸æˆ</h3>
                    <div class="form-group">
                        <label for="gameType">æ¸¸æˆç±»å‹:</label>
                        <select id="gameType">
                            <option value="puzzle">ç›Šæ™ºæ¸¸æˆ</option>
                            <option value="action">åŠ¨ä½œæ¸¸æˆ</option>
                            <option value="strategy">ç­–ç•¥æ¸¸æˆ</option>
                            <option value="arcade">è¡—æœºæ¸¸æˆ</option>
                        </select>
                    </div>
                    <button id="startGame" class="btn">å¼€å§‹æ¸¸æˆ</button>
                </div>

                <div id="activeGameSession" class="hidden">
                    <h3>å½“å‰æ¸¸æˆä¼šè¯</h3>
                    <div class="game-details">
                        <div class="detail-row">
                            <span class="detail-label">ä¼šè¯ID:</span>
                            <span class="detail-value" id="currentSessionId">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">æ¸¸æˆç±»å‹:</span>
                            <span class="detail-value" id="currentGameType">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">å¼€å§‹æ—¶é—´:</span>
                            <span class="detail-value" id="currentStartTime">-</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">å½“å‰åˆ†æ•°:</span>
                            <span class="detail-value score-highlight" id="currentScore">0</span>
                        </div>
                    </div>
                    
                    <div class="score-input">
                        <input type="number" id="scoreInput" placeholder="è¾“å…¥åˆ†æ•°" min="0">
                        <button id="submitScore" class="btn">æäº¤åˆ†æ•°</button>
                        <button id="endGame" class="btn btn-danger">ç»“æŸæ¸¸æˆ</button>
                    </div>
                </div>
            </div>

            <!-- æ¸¸æˆè®°å½• -->
            <div id="sessions" class="tab-content">
                <h2>æ¸¸æˆè®°å½•</h2>
                <div class="form-group">
                    <button id="loadSessions" class="btn btn-secondary">åˆ·æ–°è®°å½•</button>
                </div>
                <div id="sessionsList" class="grid">
                    <!-- æ¸¸æˆè®°å½•å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>

            <!-- æ’è¡Œæ¦œ -->
            <div id="leaderboard" class="tab-content">
                <h2>æ’è¡Œæ¦œ</h2>
                <div class="form-group">
                    <button id="loadLeaderboard" class="btn btn-secondary">åˆ·æ–°æ’è¡Œæ¦œ</button>
                </div>
                <div class="leaderboard" id="leaderboardList">
                    <!-- æ’è¡Œæ¦œå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>

            <!-- ç®¡ç†é¢æ¿ -->
            <div id="admin" class="tab-content">
                <h2>ç®¡ç†é¢æ¿</h2>
                
                <div id="adminPanel" class="hidden">
                    <h3>ç®¡ç†å‘˜åŠŸèƒ½</h3>
                    <div class="form-group">
                        <label for="adminAddress">æ·»åŠ ç®¡ç†å‘˜:</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="adminAddress" placeholder="ç®¡ç†å‘˜åœ°å€">
                            <button id="addAdmin" class="btn btn-secondary">æ·»åŠ </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="achievementPlayer">è§£é”æˆå°±:</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="text" id="achievementPlayer" placeholder="ç©å®¶åœ°å€">
                            <input type="text" id="achievementName" placeholder="æˆå°±åç§°">
                        </div>
                        <button id="unlockAchievement" class="btn btn-success">è§£é”æˆå°±</button>
                    </div>
                </div>
                
                <h3>ç³»ç»Ÿç»Ÿè®¡</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalPlayers">0</div>
                        <div class="stat-label">æ€»ç©å®¶æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalSessions">0</div>
                        <div class="stat-label">æ€»æ¸¸æˆä¼šè¯</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="activeSessions">0</div>
                        <div class="stat-label">æ´»è·ƒä¼šè¯</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalAchievements">0</div>
                        <div class="stat-label">æ€»æˆå°±æ•°</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://unpkg.com/fhevmjs@0.3.3/bundle/index.js"></script>
    <script>
        let provider, signer, contract, fhevmInstance;
        let userAddress = null;
        let isAdmin = false;
        let currentSessionId = null;

        // åˆçº¦é…ç½®
        let CONTRACT_ADDRESS = ''; // å°†åœ¨éƒ¨ç½²åå¡«å…¥
        const CONTRACT_ABI = [
            // GamingSystem ABI
            "function owner() view returns (address)",
            "function isAdmin(address) view returns (bool)",
            "function isRegistered(address) view returns (bool)",
            "function sessionCount() view returns (uint256)",
            "function addAdmin(address admin) external",
            "function registerPlayer() external",
            "function startGameSession(string memory gameType) external returns (uint256)",
            "function submitScore(uint256 sessionId, bytes32 encryptedScore, bytes calldata inputProof) external",
            "function endGameSession(uint256 sessionId) external",
            "function getGameSession(uint256 sessionId) view returns (tuple(uint256 id, address player, string gameType, uint256 startTime, uint256 endTime, bool isActive))",
            "function getPlayerStats(address player) view returns (tuple(uint256 totalGames, uint256 totalScore, uint256 averageScore, uint256 highestScore))",
            "function getPlayerRank(address player) view returns (uint256)",
            "function getLeaderboardSize() view returns (uint256)",
            "function getLeaderboardEntry(uint256 index) view returns (address player, uint256 score)",
            "function compareScores(address player1, address player2) view returns (bool)",
            "function unlockAchievement(address player, string memory achievementName) external",
            "function getPlayerAchievements(address player) view returns (string[] memory)",
            "function hasActiveSession(address player) view returns (bool)",
            "function getActiveSessionId(address player) view returns (uint256)",
            "event PlayerRegistered(address indexed player)",
            "event GameSessionStarted(uint256 indexed sessionId, address indexed player, string gameType)",
            "event ScoreSubmitted(uint256 indexed sessionId, address indexed player, uint256 timestamp)",
            "event GameSessionEnded(uint256 indexed sessionId, address indexed player, uint256 endTime)",
            "event AchievementUnlocked(address indexed player, string achievementName)"
        ];

        // åˆå§‹åŒ–
        async function init() {
            try {
                await loadConfig();
                await initializeFHEVM();
                setupEventListeners();
                showStatus('ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ', 'info');
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                showStatus('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŠ è½½é…ç½®
        async function loadConfig() {
            try {
                const response = await fetch('/config.json');
                const config = await response.json();
                CONTRACT_ADDRESS = config.contracts.GamingSystem;
            } catch (error) {
                console.warn('æ— æ³•åŠ è½½é…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®');
            }
        }

        // åˆå§‹åŒ–FHEVM
        async function initializeFHEVM() {
            try {
                fhevmInstance = await fhevm.createInstance({
                    chainId: 31337,
                    networkUrl: 'http://localhost:8545',
                    gatewayUrl: 'http://localhost:8545'
                });
                console.log('FHEVMå®ä¾‹åˆå§‹åŒ–æˆåŠŸ');
            } catch (error) {
                console.error('FHEVMåˆå§‹åŒ–å¤±è´¥:', error);
                throw error;
            }
        }

        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    throw new Error('è¯·å®‰è£…MetaMaské’±åŒ…');
                }

                await window.ethereum.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();

                if (CONTRACT_ADDRESS) {
                    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                    await checkUserRole();
                    await checkRegistration();
                }

                updateWalletUI();
                await loadPlayerInfo();
                showStatus('é’±åŒ…è¿æ¥æˆåŠŸ', 'success');
            } catch (error) {
                console.error('é’±åŒ…è¿æ¥å¤±è´¥:', error);
                showStatus('é’±åŒ…è¿æ¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ£€æŸ¥ç”¨æˆ·è§’è‰²
        async function checkUserRole() {
            try {
                isAdmin = await contract.isAdmin(userAddress);
                
                if (isAdmin) {
                    document.getElementById('adminPanel').classList.remove('hidden');
                }
            } catch (error) {
                console.error('æ£€æŸ¥ç”¨æˆ·è§’è‰²å¤±è´¥:', error);
            }
        }

        // æ£€æŸ¥æ³¨å†ŒçŠ¶æ€
        async function checkRegistration() {
            try {
                const isRegistered = await contract.isRegistered(userAddress);
                
                if (!isRegistered) {
                    const shouldRegister = confirm('æ‚¨è¿˜æœªæ³¨å†Œä¸ºç©å®¶ï¼Œæ˜¯å¦ç°åœ¨æ³¨å†Œï¼Ÿ');
                    if (shouldRegister) {
                        await registerPlayer();
                    }
                }
            } catch (error) {
                console.error('æ£€æŸ¥æ³¨å†ŒçŠ¶æ€å¤±è´¥:', error);
            }
        }

        // æ³¨å†Œç©å®¶
        async function registerPlayer() {
            try {
                showStatus('æ­£åœ¨æ³¨å†Œç©å®¶...', 'info');
                
                const tx = await contract.registerPlayer();
                await tx.wait();
                
                showStatus('ç©å®¶æ³¨å†ŒæˆåŠŸ', 'success');
            } catch (error) {
                console.error('æ³¨å†Œç©å®¶å¤±è´¥:', error);
                showStatus('æ³¨å†Œç©å®¶å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ›´æ–°é’±åŒ…UI
        function updateWalletUI() {
            const connectBtn = document.getElementById('connectWallet');
            const addressSpan = document.getElementById('walletAddress');
            
            if (userAddress) {
                connectBtn.textContent = 'å·²è¿æ¥';
                connectBtn.disabled = true;
                addressSpan.textContent = `${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
                addressSpan.classList.remove('hidden');
                document.getElementById('playerInfo').classList.remove('hidden');
            }
        }

        // åŠ è½½ç©å®¶ä¿¡æ¯
        async function loadPlayerInfo() {
            if (!contract || !userAddress) return;

            try {
                const stats = await contract.getPlayerStats(userAddress);
                const rank = await contract.getPlayerRank(userAddress);
                const achievements = await contract.getPlayerAchievements(userAddress);
                
                document.getElementById('totalGames').textContent = stats.totalGames.toString();
                document.getElementById('totalScore').textContent = stats.totalScore.toString();
                document.getElementById('averageScore').textContent = stats.averageScore.toString();
                document.getElementById('highestScore').textContent = stats.highestScore.toString();
                document.getElementById('playerRank').textContent = rank.eq(0) ? '-' : rank.toString();
                document.getElementById('achievementCount').textContent = achievements.length.toString();
                
                // æ˜¾ç¤ºæˆå°±
                const achievementsDiv = document.getElementById('playerAchievements');
                achievementsDiv.innerHTML = '';
                achievements.forEach(achievement => {
                    const achievementSpan = document.createElement('span');
                    achievementSpan.className = 'achievement';
                    achievementSpan.textContent = achievement;
                    achievementsDiv.appendChild(achievementSpan);
                });
                
                // æ£€æŸ¥æ˜¯å¦æœ‰æ´»è·ƒä¼šè¯
                const hasActive = await contract.hasActiveSession(userAddress);
                if (hasActive) {
                    currentSessionId = await contract.getActiveSessionId(userAddress);
                    await loadActiveSession();
                }
                
                // åŠ è½½ç³»ç»Ÿç»Ÿè®¡
                await loadSystemStats();
            } catch (error) {
                console.error('åŠ è½½ç©å®¶ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // åŠ è½½æ´»è·ƒä¼šè¯
        async function loadActiveSession() {
            if (!currentSessionId) return;
            
            try {
                const session = await contract.getGameSession(currentSessionId);
                
                document.getElementById('currentSessionId').textContent = currentSessionId.toString();
                document.getElementById('currentGameType').textContent = session.gameType;
                document.getElementById('currentStartTime').textContent = new Date(session.startTime * 1000).toLocaleString();
                document.getElementById('currentScore').textContent = '***'; // åŠ å¯†åˆ†æ•°
                
                document.getElementById('activeGameSession').classList.remove('hidden');
                document.getElementById('startGame').disabled = true;
            } catch (error) {
                console.error('åŠ è½½æ´»è·ƒä¼šè¯å¤±è´¥:', error);
            }
        }

        // å¼€å§‹æ¸¸æˆ
        async function startGame() {
            if (!contract || !userAddress) {
                showStatus('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
                return;
            }

            const gameType = document.getElementById('gameType').value;
            
            try {
                showStatus('æ­£åœ¨å¼€å§‹æ¸¸æˆ...', 'info');
                
                const tx = await contract.startGameSession(gameType);
                const receipt = await tx.wait();
                
                // ä»äº‹ä»¶ä¸­è·å–ä¼šè¯ID
                const event = receipt.events.find(e => e.event === 'GameSessionStarted');
                if (event) {
                    currentSessionId = event.args.sessionId;
                    await loadActiveSession();
                }
                
                showStatus('æ¸¸æˆå¼€å§‹æˆåŠŸ', 'success');
            } catch (error) {
                console.error('å¼€å§‹æ¸¸æˆå¤±è´¥:', error);
                showStatus('å¼€å§‹æ¸¸æˆå¤±è´¥: ' + error.message, 'error');
            }
        }

        // æäº¤åˆ†æ•°
        async function submitScore() {
            if (!contract || !userAddress || !currentSessionId) {
                showStatus('æ²¡æœ‰æ´»è·ƒçš„æ¸¸æˆä¼šè¯', 'error');
                return;
            }

            const score = document.getElementById('scoreInput').value;
            if (!score || parseInt(score) < 0) {
                showStatus('è¯·è¾“å…¥æœ‰æ•ˆçš„åˆ†æ•°', 'error');
                return;
            }

            try {
                showStatus('æ­£åœ¨æäº¤åˆ†æ•°...', 'info');
                
                // åŠ å¯†åˆ†æ•°
                const encryptedScore = fhevmInstance.encrypt32(parseInt(score));
                
                const tx = await contract.submitScore(
                    currentSessionId,
                    encryptedScore.handles[0],
                    encryptedScore.inputProof
                );
                
                await tx.wait();
                showStatus('åˆ†æ•°æäº¤æˆåŠŸ', 'success');
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                document.getElementById('scoreInput').value = '';
                
                // æ›´æ–°å½“å‰åˆ†æ•°æ˜¾ç¤º
                document.getElementById('currentScore').textContent = '***';
            } catch (error) {
                console.error('æäº¤åˆ†æ•°å¤±è´¥:', error);
                showStatus('æäº¤åˆ†æ•°å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ç»“æŸæ¸¸æˆ
        async function endGame() {
            if (!contract || !userAddress || !currentSessionId) {
                showStatus('æ²¡æœ‰æ´»è·ƒçš„æ¸¸æˆä¼šè¯', 'error');
                return;
            }

            try {
                showStatus('æ­£åœ¨ç»“æŸæ¸¸æˆ...', 'info');
                
                const tx = await contract.endGameSession(currentSessionId);
                await tx.wait();
                
                showStatus('æ¸¸æˆç»“æŸæˆåŠŸ', 'success');
                
                // é‡ç½®UI
                currentSessionId = null;
                document.getElementById('activeGameSession').classList.add('hidden');
                document.getElementById('startGame').disabled = false;
                
                // åˆ·æ–°ç©å®¶ä¿¡æ¯
                await loadPlayerInfo();
            } catch (error) {
                console.error('ç»“æŸæ¸¸æˆå¤±è´¥:', error);
                showStatus('ç»“æŸæ¸¸æˆå¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŠ è½½æ¸¸æˆè®°å½•
        async function loadSessions() {
            if (!contract || !userAddress) {
                showStatus('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
                return;
            }

            try {
                showStatus('æ­£åœ¨åŠ è½½æ¸¸æˆè®°å½•...', 'info');
                
                const sessionCount = await contract.sessionCount();
                const sessionsList = document.getElementById('sessionsList');
                sessionsList.innerHTML = '';

                if (sessionCount.eq(0)) {
                    sessionsList.innerHTML = '<p>æš‚æ— æ¸¸æˆè®°å½•</p>';
                    return;
                }

                let userSessions = [];
                for (let i = 0; i < sessionCount.toNumber(); i++) {
                    const session = await contract.getGameSession(i);
                    if (session.player.toLowerCase() === userAddress.toLowerCase()) {
                        userSessions.push({ ...session, id: i });
                    }
                }

                if (userSessions.length === 0) {
                    sessionsList.innerHTML = '<p>æ‚¨è¿˜æ²¡æœ‰æ¸¸æˆè®°å½•</p>';
                    return;
                }

                userSessions.reverse().forEach(session => {
                    const sessionCard = createSessionCard(session);
                    sessionsList.appendChild(sessionCard);
                });

                showStatus('æ¸¸æˆè®°å½•åŠ è½½å®Œæˆ', 'success');
            } catch (error) {
                console.error('åŠ è½½æ¸¸æˆè®°å½•å¤±è´¥:', error);
                showStatus('åŠ è½½æ¸¸æˆè®°å½•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ›å»ºæ¸¸æˆè®°å½•å¡ç‰‡
        function createSessionCard(session) {
            const card = document.createElement('div');
            card.className = 'game-card';
            
            const statusClass = session.isActive ? 'active' : 'ended';
            const statusText = session.isActive ? 'è¿›è¡Œä¸­' : 'å·²ç»“æŸ';
            
            card.innerHTML = `
                <div class="game-header">
                    <div class="game-title">æ¸¸æˆä¼šè¯ #${session.id}</div>
                    <div class="game-status ${statusClass}">${statusText}</div>
                </div>
                <div class="game-details">
                    <div class="detail-row">
                        <span class="detail-label">æ¸¸æˆç±»å‹:</span>
                        <span class="detail-value">${session.gameType}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">å¼€å§‹æ—¶é—´:</span>
                        <span class="detail-value">${new Date(session.startTime * 1000).toLocaleString()}</span>
                    </div>
                    ${!session.isActive ? `
                        <div class="detail-row">
                            <span class="detail-label">ç»“æŸæ—¶é—´:</span>
                            <span class="detail-value">${new Date(session.endTime * 1000).toLocaleString()}</span>
                        </div>
                    ` : ''}
                    <div class="detail-row">
                        <span class="detail-label">åˆ†æ•°:</span>
                        <span class="detail-value score-highlight">*** (åŠ å¯†)</span>
                    </div>
                </div>
            `;
            
            return card;
        }

        // åŠ è½½æ’è¡Œæ¦œ
        async function loadLeaderboard() {
            if (!contract) {
                showStatus('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
                return;
            }

            try {
                showStatus('æ­£åœ¨åŠ è½½æ’è¡Œæ¦œ...', 'info');
                
                const leaderboardSize = await contract.getLeaderboardSize();
                const leaderboardList = document.getElementById('leaderboardList');
                leaderboardList.innerHTML = '';

                if (leaderboardSize.eq(0)) {
                    leaderboardList.innerHTML = '<p>æ’è¡Œæ¦œæš‚æ— æ•°æ®</p>';
                    return;
                }

                for (let i = 0; i < Math.min(leaderboardSize.toNumber(), 10); i++) {
                    const entry = await contract.getLeaderboardEntry(i);
                    const item = createLeaderboardItem(i + 1, entry.player, entry.score);
                    leaderboardList.appendChild(item);
                }

                showStatus('æ’è¡Œæ¦œåŠ è½½å®Œæˆ', 'success');
            } catch (error) {
                console.error('åŠ è½½æ’è¡Œæ¦œå¤±è´¥:', error);
                showStatus('åŠ è½½æ’è¡Œæ¦œå¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ›å»ºæ’è¡Œæ¦œé¡¹ç›®
        function createLeaderboardItem(rank, player, score) {
            const item = document.createElement('div');
            item.className = 'leaderboard-item';
            
            let rankClass = '';
            if (rank === 1) rankClass = 'gold';
            else if (rank === 2) rankClass = 'silver';
            else if (rank === 3) rankClass = 'bronze';
            
            const isCurrentUser = userAddress && player.toLowerCase() === userAddress.toLowerCase();
            
            item.innerHTML = `
                <div class="rank ${rankClass}">#${rank}</div>
                <div class="player-name">
                    ${player.slice(0, 6)}...${player.slice(-4)}
                    ${isCurrentUser ? ' (æ‚¨)' : ''}
                </div>
                <div class="player-score">*** åˆ†</div>
            `;
            
            if (isCurrentUser) {
                item.style.background = '#f0f8ff';
                item.style.border = '2px solid #667eea';
            }
            
            return item;
        }

        // åŠ è½½ç³»ç»Ÿç»Ÿè®¡
        async function loadSystemStats() {
            if (!contract) return;

            try {
                const sessionCount = await contract.sessionCount();
                const leaderboardSize = await contract.getLeaderboardSize();
                
                document.getElementById('totalSessions').textContent = sessionCount.toString();
                document.getElementById('totalPlayers').textContent = leaderboardSize.toString();
                
                // è®¡ç®—æ´»è·ƒä¼šè¯æ•°ï¼ˆç®€åŒ–å®ç°ï¼‰
                let activeSessions = 0;
                for (let i = 0; i < Math.min(sessionCount.toNumber(), 100); i++) {
                    const session = await contract.getGameSession(i);
                    if (session.isActive) activeSessions++;
                }
                document.getElementById('activeSessions').textContent = activeSessions.toString();
                
                // æ€»æˆå°±æ•°ï¼ˆæ¨¡æ‹Ÿæ•°æ®ï¼‰
                document.getElementById('totalAchievements').textContent = '12';
            } catch (error) {
                console.error('åŠ è½½ç³»ç»Ÿç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        // æ·»åŠ ç®¡ç†å‘˜
        async function addAdmin() {
            if (!contract || !isAdmin) {
                showStatus('åªæœ‰ç®¡ç†å‘˜å¯ä»¥æ·»åŠ å…¶ä»–ç®¡ç†å‘˜', 'error');
                return;
            }

            const adminAddress = document.getElementById('adminAddress').value;
            if (!adminAddress || !ethers.utils.isAddress(adminAddress)) {
                showStatus('è¯·è¾“å…¥æœ‰æ•ˆçš„åœ°å€', 'error');
                return;
            }

            try {
                showStatus('æ­£åœ¨æ·»åŠ ç®¡ç†å‘˜...', 'info');
                
                const tx = await contract.addAdmin(adminAddress);
                await tx.wait();
                
                showStatus('ç®¡ç†å‘˜æ·»åŠ æˆåŠŸ', 'success');
                document.getElementById('adminAddress').value = '';
            } catch (error) {
                console.error('æ·»åŠ ç®¡ç†å‘˜å¤±è´¥:', error);
                showStatus('æ·»åŠ ç®¡ç†å‘˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // è§£é”æˆå°±
        async function unlockAchievement() {
            if (!contract || !isAdmin) {
                showStatus('åªæœ‰ç®¡ç†å‘˜å¯ä»¥è§£é”æˆå°±', 'error');
                return;
            }

            const playerAddress = document.getElementById('achievementPlayer').value;
            const achievementName = document.getElementById('achievementName').value;
            
            if (!playerAddress || !ethers.utils.isAddress(playerAddress)) {
                showStatus('è¯·è¾“å…¥æœ‰æ•ˆçš„ç©å®¶åœ°å€', 'error');
                return;
            }
            
            if (!achievementName) {
                showStatus('è¯·è¾“å…¥æˆå°±åç§°', 'error');
                return;
            }

            try {
                showStatus('æ­£åœ¨è§£é”æˆå°±...', 'info');
                
                const tx = await contract.unlockAchievement(playerAddress, achievementName);
                await tx.wait();
                
                showStatus('æˆå°±è§£é”æˆåŠŸ', 'success');
                document.getElementById('achievementPlayer').value = '';
                document.getElementById('achievementName').value = '';
            } catch (error) {
                console.error('è§£é”æˆå°±å¤±è´¥:', error);
                showStatus('è§£é”æˆå°±å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„æ´»è·ƒçŠ¶æ€
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾å†…å®¹
            document.getElementById(tabName).classList.add('active');
            
            // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾
            event.target.classList.add('active');
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.classList.remove('hidden');
            
            setTimeout(() => {
                statusDiv.classList.add('hidden');
            }, 5000);
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            document.getElementById('connectWallet').addEventListener('click', connectWallet);
            document.getElementById('startGame').addEventListener('click', startGame);
            document.getElementById('submitScore').addEventListener('click', submitScore);
            document.getElementById('endGame').addEventListener('click', endGame);
            document.getElementById('loadSessions').addEventListener('click', loadSessions);
            document.getElementById('loadLeaderboard').addEventListener('click', loadLeaderboard);
            document.getElementById('addAdmin').addEventListener('click', addAdmin);
            document.getElementById('unlockAchievement').addEventListener('click', unlockAchievement);

            // ç›‘å¬è´¦æˆ·å˜åŒ–
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length === 0) {
                        location.reload();
                    } else {
                        location.reload();
                    }
                });

                window.ethereum.on('chainChanged', () => {
                    location.reload();
                });
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);

        // å…¨å±€å‡½æ•°ï¼Œä¾›HTMLè°ƒç”¨
        window.switchTab = switchTab;
    </script>
</body>
</html>